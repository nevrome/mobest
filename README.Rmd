---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- Rmd -> md --> 

# mobest

This R package provides a pipeline for spatiotemporal interpolation of human genetic ancestry components and a derived measure for **mob**ility **est**imation. The workflow in version 1.0 was specifically developed for this research paper:

> ..., Estimating human mobility in Holocene Western Eurasia with bulk ancient genetic data, ...

## Installation

Install the package from github with the following command in R:

```
if(!require('remotes')) install.packages('remotes')
remotes::install_github('nevrome/mobest')
```

## Workflow

`mobest` assumes you have a set of ancient DNA samples with spatial (two coordinates in a projected reference system) and temporal positions (years BC/AD) for which you calculated a derived, numeric measure of genetic ancestry (e.g. coordinates in a multidimensional scaling space). This package now provides a framework to perform spatiotemporal interpolation using Gaussian process regression (kriging) with the [`laGP`](https://CRAN.R-project.org/package=laGP) package to reconstruct an ancestry field based on the ancestry measure you provided. `mobest` then allows to estimate a point-wise measure of mobility based on a search for “ancestry origin” positions with similar genetic make-up in the respective past.

The research paper linked above explains the details and background. The following guide just briefly lists the functions in the order you would usually call them and introduces the interface from a technical point of view.

### Basic classes for the input data

`create_spatpos` creates an object of class `mobest_spatiotemporalpositions` which is a `data.frame` that represents spatiotemporal positions.

```{r, echo=F}
set.seed(123)
```

```{r}
positions <- mobest::create_spatpos(
  id = 1:100,
  x = c(sample(100000:700000, 50), sample(300000:1000000, 50)),
  y = c(sample(100000:700000, 50), sample(300000:1000000, 50)),
  z = c(sample(-5000:-3500, 50), sample(-4500:-3000, 50))
)
```

```{r, echo=F}
positions
```

`create_spatpos_multi` creates a list of `mobest_spatiotemporalpositions` objects. It's meant to represent positional uncertainty, by providing multiple sets of spatiotemporal coordinates for points with identical IDs.

```{r}
uncertain_positions <- mobest::create_spatpos_multi(
  id = 1:100,
  x = list(positions$x, positions$x),
  y = list(positions$y, positions$y),
  z = list(positions$z + sample(-100:100, 100), positions$z + sample(-100:100, 100)),
  it = c("run_a", "run_b")
)
```

```{r, echo=F}
uncertain_positions
```

`create_obs` creates named lists of observations vectors (class `mobest_observations`) corresponding to the spatiotemporal positions defined above.

```{r}
observations <- mobest::create_obs(
  ac1 = c(runif(50, 0, 0.6), runif(50, 0.4, 1)), # "ac" for "ancestry component"
  ac2 = c(runif(50, 0, 0.3), runif(50, 0.5, 1))
)
```

The first ten observations:

```{r, echo=F}
lapply(observations, head, N = 10)
```

### Parameter estimation

Gaussian process regression requires a parametrized covariance function (a "kernel"). `mobest` provides helper functions to estimate the relevant parameters from the input data.

#### Variogram calculation

`mobest::calculate_pairwise_distances` calculates different types of pairwise distances (spatial, temporal, ancestry components) and returns them in a long format `data.frame` object of class `mobest_pairwisedistances`.

```{r}
pairwise_distances <- mobest::calculate_pairwise_distances(
  independent = positions,
  dependent = observations,
  m_to_km = T
)
```

```{r, echo=F}
pairwise_distances
```

`mobest::bin_pairwise_distances` bins the pairwaise differences in an object of class `mobest_pairwisedistances` and calculates an empirical variogram (class `mobest_empiricalvariogram`) from them.

```{r}
variogram <- mobest::bin_pairwise_distances(
  pairwise_distances,
  geo_bin = 0.1, time_bin = 100
)
```

```{r, echo=F}
variogram
```

#### Maximum likelihood estimation

`mobest::laGP_mle_anisotropic` wraps around `laGP::mleGPsep` to perform marginal maximum likelihood inference for anisotropic (separable) Gaussian lengthscale and nugget parameters.

```{r}
mleGPsep_out <- mobest::laGP_mle_anisotropic(
  independent = dplyr::mutate(positions, x = x/1000, y = y/1000),
  dependent = observations,
  iterations = 2,
  verb = 0
)
```

```{r, echo=F}
mleGPsep_out
```

`mobest::laGP_jmle_anisotropic` wraps around `laGP::mleGPsep` to perform joint maximum likelihood inference for anisotropic (separable) Gaussian lengthscale and nugget parameters.

```{r}
jmleGPsep_out <- mobest::laGP_jmle_anisotropic(
  independent = dplyr::mutate(positions, x = x/1000, y = y/1000),
  dependent = observations,
  iterations = 2,
  verb = 0
)
```

```{r, echo=F}
jmleGPsep_out
```

`mobest::laGP_mle_sequence_isotropic_fixed_g` implements a very specific approach where the mle is performed under the assumption of an isotropic system, but with a series of scaling factors for the space-time-relation. The nugget term g is fixed.

```{r}
mle_sequence <- mobest::laGP_mle_sequence_isotropic_fixed_g(
  independent = dplyr::mutate(positions, x = x/1000, y = y/1000),
  dependent = observations,
  iterations = 2,
  g = 0.1,
  space_time_scaling_factor_sequence = c(seq(0.1, 0.9, 0.1), 1, seq(2, 10, 1)),
  verb = 0
)
```

```{r, echo=F}
mle_sequence
```

#### Crossvalidation

`mobest::crossvalidate` allows to tackle the parameter estimation challenge with simple cross-validation across a grid of kernel function parameters. Internally it already employs `mobest::create_model_grid` and `mobest::run_model_grid`.

```{r, message=FALSE}
interpol_comparison <- mobest::crossvalidate(
  independent = positions,
  dependent = observations,
  kernel = mobest::create_kernset_cross(
    ds = seq(100,200, 50)*1000,
    dt = seq(100,200, 50), 
    g = 0.1
  ),
  iterations = 2,
  groups = 10
)
```

```{r, echo=F}
interpol_comparison
```

### Spatiotemporal interpolation

The spatiotemporal interpolation workflow consists of the creation of a list of models and then running each element on this list.

`mobest::create_model_grid` creates an object of class `mobest_modelgrid` which holds all permutations of input elements. Each row equals one complete model definition with all parameters and input data fully defined.

```{r}
model_grid <- mobest::create_model_grid(
  independent = uncertain_positions,
  dependent = observations,
  kernel = mobest::create_kernset_multi(
    d = list(c(100000, 100000, 200)),
    g = 0.1,
    it = "kernel_100000_200_01"
  ),
  prediction_grid = list(
    pred_grid = expand.grid(
      x = seq(100000, 1000000, 100000),
      y = seq(100000, 1000000, 100000),
      z = seq(-5000, -3000, 400)
    ) %>% {create_spatpos(
      id = 1:nrow(.),
      x = .$x,
      y = .$y,
      z = .$z
    )}
  )
)
```

```{r, echo=F}
model_grid
```

The helper function `mobest::prediction_grid_for_spatiotemporal_area` can be used to construct a regular, spatiotemporal grid for the `prediction_grid` argument. It uses `sf::st_make_grid` under the hood to create the spatial grid for an input region.

`mobest::run_model_grid` runs each model and returns an unnested table of interpolation results for each prediction grid point and each model parameter setting.

```{r}
interpol_grid <- mobest::run_model_grid(model_grid, quiet = T)
```

```{r, echo=F}
interpol_grid
```

### Mobility estimation

```{r}
search_spatial_origin
interpol_grid
```


