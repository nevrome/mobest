---
output: github_document
editor_options: 
  chunk_output_type: console
---

<!-- Rmd -> md --> 

# mobest

This R package provides a pipeline for spatiotemporal interpolation of human genetic ancestry components and a derived measure for **mob**ility **est**imation. The workflow in version 1.0 was specifically developed for this research paper:

> ..., Estimating human mobility in Holocene Western Eurasia with bulk ancient genetic data, ...

## Installation

Install the package from github with the following command in R:

```
if(!require('remotes')) install.packages('remotes')
remotes::install_github('nevrome/mobest')
```

## Workflow

`mobest` assumes you have a set of ancient DNA samples with spatial (two coordinates in a projected reference system) and temporal positions (years BC/AD) for which you calculated a derived, numeric measure of genetic ancestry (e.g. coordinates in a multidimensional scaling space). This package now provides a framework to perform spatiotemporal interpolation using Gaussian process regression (kriging) with the [`laGP`](https://CRAN.R-project.org/package=laGP) package to reconstruct an ancestry field based on the ancestry measure you provided. `mobest` then allows to estimate a point-wise measure of mobility based on a search for “ancestry origin” positions with similar genetic make-up in the respective past.

The research paper linked above explains the details and background. The following guide just briefly lists the functions in the order you would usually call them and introduces the interface from a technical point of view.

### Basic classes for the input data

`create_spatpos` creates an object of class `mobest_spatiotemporalpositions` which is a `data.frame` that represents spatiotemporal positions.

```{r}
positions <- mobest::create_spatpos(
  id = 1:100,
  x = sample(100000:500000, 100),
  y = sample(500000:999999, 100),
  z = sample(-5000:-3000, 100)
)
```

```{r, echo=F}
positions
```

`create_spatpos_multi` creates a list of `mobest_spatiotemporalpositions` objects. It's meant to represent positional uncertainty, by providing multiple sets of spatiotemporal coordinates for points with identical IDs.

```{r}
uncertain_positions <- mobest::create_spatpos_multi(
  id = 1:100,
  x = list(positions$x, positions$x),
  y = list(positions$y, positions$y),
  z = list(positions$y + sample(-100:100, 100), positions$y + sample(-100:100, 100)),
  it = c("run_a", "run_b")
)
```

```{r, echo=F}
uncertain_positions
```

`create_obs` creates named lists of observations vectors (class `mobest_observations`) corresponding to the spatiotemporal positions defined above.

```{r}
observations <- mobest::create_obs(
  ac1 = runif(100, 0, 1), # "ac" for "ancestry component"
  ac2 = runif(100, 0, 1)
)
```

The first ten observations:

```{r, echo=F}
lapply(observations, head, N = 10)
```

### Parameter estimation

Gaussian process regression requires a parametrized covariance function. `mobest` provides helper functions to estimate the relevant parameters from the input data.

#### Variogram calculation

`mobest::calculate_pairwise_distances` calculates different types of pairwise distances (spatial, temporal, ancestry components) and returns them in a long format `data.frame` object of class `mobest_pairwisedistances`.

```{r}
pairwise_distances <- mobest::calculate_pairwise_distances(
  independent = positions,
  dependent = observations,
  m_to_km = T
)
```

```{r, echo=F}
pairwise_distances
```

`mobest::bin_pairwise_distances` bins the pairwaise differences in an object of class `mobest_pairwisedistances` and calculates an empirical variogram (class `mobest_empiricalvariogram`) from them.

```{r}
variogram <- mobest::bin_pairwise_distances(
  pairwise_distances,
  geo_bin = 0.1, time_bin = 100
)
```

```{r, echo=F}
variogram
```

#### Maximum likelihood estimation

`mobest::laGP_mle_anisotropic` wraps around `laGP::mleGPsep` to perform marginal maximum likelihood inference for anisotropic (separable) Gaussian lengthscale and nugget parameters.

```{r}
mleGPsep_out <- mobest::laGP_mle_anisotropic(
  independent = dplyr::mutate(positions, x = x/1000, y = y/1000),
  dependent = observations,
  iterations = 2
)
```

```{r, echo=F}
mleGPsep_out
```

`mobest::laGP_jmle_anisotropic` wraps around `laGP::mleGPsep` to perform joint maximum likelihood inference for anisotropic (separable) Gaussian lengthscale and nugget parameters.

```{r}
jmleGPsep_out <- mobest::laGP_jmle_anisotropic(
  independent = dplyr::mutate(positions, x = x/1000, y = y/1000),
  dependent = observations,
  iterations = 2
)
```

```{r, echo=F}
jmleGPsep_out
```

#### Crossvalidation

### Spatiotemporal interpolation



### Mobility estimation




